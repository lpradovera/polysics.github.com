---
layout: post
title: Menu DSL in Adhearsion 2.0
tags: [menu, dsl, adhearsion]
last_updated: 2011-12-01
---

The menu DSL has received a major overhaul in Adhearsion 2.0, with the goals of clarifying syntax and adding functionality.

Call Controllers
----------------

AHN 2.0 is now using a routing architecture and call controllers instead of dialplan.rb.
Call controllers allow your code to be grouped into classes, instead of stuffed into dialplan.rb.
A detailed explanation of the call controller architecture will be the subject of another post, but in the meantime a few core concepts will be handy.
Every controller implements a *run* method that acts as the entry point for its functionality.

Calls reach the correct controller through the router, that accommodates most application logics.
The routing functionality will be also explained in a following post.

{% highlight ruby %}
class MyOtherController < Adhearsion::CallController
  def run
    speak 'foobar'
  end
end

# the following resides in routes.rb and route any call to MyController
route :to => MyController
{% endhighlight %}

Previous Menu DSL
----------------

The Adhearsion 1.x menu structure used to work as follows, with the now obsolete concept of a dialplan and context.

{% highlight ruby %}
# sample dialplan.rb
foo {
  menu "Press 1 for Administration", "Press 2 for Tech Support", :timeout => 8.seconds, :tries => 3 do |link|
    link.admin 1
    link.tech 2
    
    link.on_invalid do
      speak 'Invalid input'
    end

    link.on_premature_timeout do
      speak 'Sorry'
    end

    link.on_failure do
      speak 'Goodbye'
      hangup
    end

  end
}

admin {
  speak 'You have reached the Administration department'
}

tech {
  speak 'You have reached the Technical Support office'
}
{% endhighlight %}

Current implementation of the Menu DSL
----------------------

The focus for the menu DSL in Adhearsion 2.0 was primarily on improving its functionality to work with call controllers and to fit the new framework structure.
Working towards those goals, the menu definition block was streamlined while keeping readability and the general functionality of 1.x.

{% highlight ruby %}
# sample controllers/my_controller.rb
class MyController < Adhearsion::CallController
  def run
    answer

    menu "Where can we take you today?", :timeout => 8.seconds, :tries => 3 do
      match 1, BooController
      match "2", MyOtherController
      match 3, 4, {
        pass YetAnotherController
      }
      match 5, FooController
      match 6..10 {|dialed|
        say_dialed dialed
      }

      timeout { timeout }

      invalid do
        invoke InvalidController
      end
      
      failure do
        speak 'Goodbye'
        hangup
      end
    end
    
    speak "This code gets executed unless pass is used"
  end

  def say_dialed(dialed)
    speak "#{dialed} was dialed"
  end
  
  def timeout
    speak 'Timeout'
  end
end
{% endhighlight %}

The first arguments to #menu are a list of sounds to play, as accepted by #play, including strings for TTS, Date and Time objects, and file paths.
:tries and :timeout options respectively specify the number of tries before going into failure, and the timeout in seconds allowed on each digit input.

The most important part is the following block, which specifies how the menu will be constructed and handled.

The *match* method takes an Integer, a String, a Range or any number of them as the required input(s) for the match payload to be executed.
The last argument to a *match* is either the name of a CallController, which will be invoked, or a block to be executed.
Matched input is passed in to the associated block, or to the controller through it instance variable @options[:extension].

*timeout*, *invalid* and *failure* replace *on_invalid*, *on_premature_timeout* and *on_failure*.
They only accept blocks as payload.

*invalid* has its associated block executed when the input does not possibly match any pattern.
*timeout* block is run when time expires before or between input digits.
*failure* runs its block when the maximum number of tries is reached without an input match.

Execution of the current context resumes after #menu finishes. If you wish to jump to an entirely different controller, use #pass.
Menu will return :failed if failure was reached, or :done if a match was executed.
