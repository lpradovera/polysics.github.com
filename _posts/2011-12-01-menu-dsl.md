---
layout: post
title: Menu DSL in Adhearsion 2.0
tags: [menu, dsl, adhearsion]
last_updated: 2011-12-01
---

The menu DSL has received a major overhaul in Adhearsion 2.0 to
make the syntax more clear and add new functionality while keeping the
core concepts.

Call Controllers
----------------

AHN 2.0 is now using a routing architecture and call controllers
instead of dialplan.rb.
CallController functionality will be detailed in another post.
An example of a simple CallController follows for reference.

{% highlight ruby %}
# A CallController has a run method that handles all interaction
class MyOtherController < Adhearsion::CallController
  def run
    speak 'foobar'
  end
end

# the following resides in routes.rb and route any call to MyController
route :to => MyController
{% endhighlight %}

Previous Menu DSL
----------------

{% highlight ruby %}
# sample dialplan.rb
foo {
  menu "Press 1 to bar", "Press 2 to Baz", :timeout => 8.seconds, :tries => 3 do |link|
    link.bar 1
    link.baz 2
    
    link.on_invalid do
      speak 'Invalid input'
    end

    link.on_premature_timeout do
      speak 'Sorry'
    end

    link.on_failure do
      speak 'Goodbye'
      hangup
    end

  end
}

bar {
  speak 'Bar'
}

baz {
  speak 'Baz'
}
{% endhighlight %}

Current implementation of the Menu DSL
----------------------

The new structure improves readability of the code while keeping
existing functionality.

{% highlight ruby %}
# sample controllers/my_controller.rb
class MyController < Adhearsion::CallController
  def run
    answer

    menu "Where can we take you today?", :timeout => 8.seconds, :tries => 3 do
      match 1, BooController
      match "2", MyOtherController
      match 3, 4, {
        pass YetAnotherController
      }
      match 5, FooController
      match 6..10 {|dialed|
        dar dialed
      }

      timeout { timeout }

      invalid do
        speak "Sorry, that's wrong!"
      end
      
      failure do
        speak 'Goodbye'
        hangup
      end
    end
    
    speak "This code gets executed unless pass is used"
  end

  def dar(dialed)
    speak "#{dialed} was dialed"
  end
  
  def timeout
    speak 'Timeout'
  end
end
{% endhighlight %}

The first arguments to #menu are a list of sounds to play, as accepted by #play, including strings for TTS, Date and Time objects, and file paths.
:tries and :timeout options respectively specify the number of tries before going into failure, and the timeout in seconds allowed on each digit input.

The most important part is the following block, which specifies how the menu will be constructed and handled.

The *match* method takes an Integer, a String, a Range or any number of them, routing it to a *CallController* passed as its class name or a block.
Matched input is passed in to the associated block, or to the controller through options.

*timeout*, *invalid* and *failure* replace *on_invalid*, *on_premature_timeout* and *on_failure*.
They only accept blocks as payload.

*invalid* has its associated block executed when the input does not possibly match any pattern.
*timeout* block is run when time expires before or between input digits.
*failure* runs its block when the maximum number of tries is reached without an input match.

Execution of the current context resumes after #menu finishes. If you wish to jump to an entirely different controller, use #pass.
Menu will return :failed if failure was reached, or :done if a match was executed.
